```{r, echo = FALSE, eval = FALSE, results='hide', message = FALSE, warning = FALSE}
tempR <- tempfile(fileext = ".R")
library(knitr)
purl("../index.Rmd", output = tempR)
source(tempR)
unlink(tempR)
```

## Audit Experiments

A pressing descriptive research questions is the extent of discrimination against marginalized groups. We want to know, on average, how much employers, bureaucrats, or other officials favor one group over another. However, measuring discrimination is hard; we don't have a magic magnifying glass we can hold up to human resources officers that will measure their level of discriminatory attitudes. Researchers instead turn to **audit studies**, which measure the level of discrimination by answering a related (but different!) causal question: what is the effect of **signaling** membership in one group over another on the **actions** taken by subjects such as calls returned, emails sent in response, or offers of information or assistance.

White, Nathan, and Faller (2015) applied the correspondence experiment to the study of discrimination by election officials. The authors sent emails from putatively White or Latino voters to election officials, seeking information about what is required in order to vote. The authors then collected data on whether election officials responded to the emails.

- **M**odel: 

    Our model of the world includes the possibility that voting officials exercise discretion when responding to citizens; sometimes they respond and sometimes they don't. This model implies there are four types of elections official. These types are enumerated in the table. "A" and "D" types don't discriminate -- they behave the same way regardless of the citizen's ethnicity. "B" types are biased in favor of Latinos and "C" types are biased in favor of Whites. Unfortunately, we can't ever directly learn officials' types due to the fundamental problem of causal inference. Instead, they express one of their two potental outcomes. Our model therefore consists of three variables: type, the treated potential outcome, and the untreated potential outcome.

| Type | $R_i(0)$ | $R_i(1)$ | Proportion |
| ---- | -------- | -------- | ---------- |
| A    | 1        | 1        | $\pi_A$    |
| B    | 0        | 1        | $\pi_B$    |
| C    | 1        | 0        | $\pi_C$    |
| D    | 0        | 0        | $\pi_D$    |

Table: Types of Election Officials.
    
- **I**nquiry: Even though this study involves random assignment to treatment conditions, we think it is best to consider the inquiry of an audit study to be **descriptive**. We're interested in the level of discrimination against Latinos among election officials: that quantity is represented by $\pi_B - \pi_C$, where $\pi$ means population proportion. This descriptive inquiry is of course mathematically identical to the causal quantity $E[R_i(1) - R_i(0)]$ but is conceputally distinct. 
    
- **D**ata strategy: The data strategy for audit experiments requires obtaining the contact information for a sample of officials. These are often culled from websites or existing email lists. Typically, they are not randomly sampled from a larger population. Subjects are randomized into treatment and control groups, often using block random assignment by geographic area or employment sector. For this example, however, we'll just consider the case of complete random assignment (Complete random assignment means selecting exactly $m$ of $N$ units into treatment and the remainder ($N$ - $m$) into control).

- **A**nswer strategy: Our answer strategy will be the difference-in-means estimator.

```{r}
# Model -------------------------------------------------------------------
population <-
  declare_population(
    N = 500,
    type = sample(c("A", "B", "C", "D"), size = N, replace = TRUE, prob = c(.40, .05, .10, .45))
  )
potential_outcomes <-
  declare_potential_outcomes(R_Z_0 = as.numeric(type %in% c("A", "C")),
                             R_Z_1 = as.numeric(type %in% c("A", "B")))

# Inquiry -----------------------------------------------------------------
estimand <- declare_estimand(mean(type == "B") - mean(type == "C"))

# Data Strategy -----------------------------------------------------------
assignment <- declare_assignment()

# Answer Strategy ---------------------------------------------------------
estimator <- declare_estimator(R ~ Z, estimand = estimand)

# Design ------------------------------------------------------------------
design <- declare_design(
  population,
  potential_outcomes,
  assignment,
  estimand,
  reveal_outcomes(outcome_variable_names = "R"),
  estimator
)
```

```{r,eval = FALSE}
diagnosis <- diagnose_design(design, sims = 1000, bootstrap = FALSE)
```

```{r, echo=FALSE, eval= rerun_templates}
diagnosis <- diagnose_design(design, sims = 1000, bootstrap = FALSE)
saveRDS(diagnosis, file = "../examples_data/06_audit_experiments_in_text.RDS")
saveRDS(design, file = "../examples_data/06_audit_experiments_design.RDS")
```

```{r, echo=FALSE, eval = !rerun_templates}
diagnosis <- readRDS("../examples_data/06_audit_experiments_in_text.RDS")
```

### Takeaways

The audit experiment is unbiased for our estimand $\pi_B - \pi_C$, as shown in the figured. This clever design uses behavioral responses to a randomly assigned treatment to measure a descriptive quantity, the average level of discrimination against Latinos.

```{r, echo=FALSE, caption = "Sampling Distribution of Three Estimators: Correspondence Experiments", fig.height = 3}
diagnosis$simulations %>%
  ggplot(aes(est)) + geom_histogram(bins = 30) +
  geom_vline(data = diagnosis$diagnosands, aes(xintercept = mean_estimand), color = "red") +
  theme(axis.title = element_blank()) +
  dd_theme
```

### Exercises

1. Modify the declaration so that the level of net discrimination is quite low, say 2 percentage points. What is the power of a 500 subject experiment to detect discrimination (using a two-tailed, p = 0.05 test).

2. Imagine that some officials have very restrictive spam filters and so they never see any of the emails sent to them.  What type are they?  How would you assess the robustness of the design to increasing proportions of officials with restrictive spam filters? 

3. Suppose that before emailing the officials, the researchers sent a letter to half of the 
